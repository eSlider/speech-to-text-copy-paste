name: Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 xdotool libasound2-dev portaudio19-dev libcairo2-dev libgirepository1.0-dev gcc pkg-config python3-dev
        
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black mypy
        
    - name: Run flake8
      run: |
        flake8 main.py --max-line-length=100 --ignore=E501,W503 || echo "flake8 issues found"
        
    - name: Run pylint
      run: |
        pylint main.py --disable=C0114,C0115,C0116 || echo "pylint issues found"
        
    - name: Check code formatting with black
      run: |
        black --check --line-length=100 main.py || echo "black formatting issues found"
        
    - name: Check shell scripts
      run: |
        shellcheck *.sh || echo "shellcheck not available or issues found"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create bandit config
      run: |
        cat > .bandit.yaml << 'EOF'
        exclude_dirs:
          - tests
        tests:
          - B101: assert_used
          - B601: shell_injection_process
        EOF
        
    - name: Run Bandit security scan
      uses: PyCQA/bandit-action@v1
      with:
        config_file: .bandit.yaml
      continue-on-error: true