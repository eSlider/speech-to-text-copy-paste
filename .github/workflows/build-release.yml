name: Build and Release

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, master ]

env:
  APP_NAME: Speech-to-Text-Agent
  PYTHON_VERSION: '3.9'

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 xdotool libasound2-dev portaudio19-dev
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install vosk sounddevice numpy PyGObject pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Test main script syntax
      run: |
        python -m py_compile main.py
        python -m py_compile launch.sh
        python -m py_compile setup.sh
        
    - name: Test desktop file
      run: |
        desktop-file-validate speech-to-text-agent.desktop || echo "desktop-file-validate not available, continuing..."

  build:
    name: Build AppImage
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 xdotool libasound2-dev portaudio19-dev wget unzip
        
    - name: Make build script executable
      run: chmod +x bin/build.sh
      
    - name: Build AppImage
      run: |
        cd bin
        ./build.sh
        
    - name: Upload AppImage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: AppImage
        path: "*.AppImage"
        retention-days: 30
        
    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## Speech-to-Text Agent v${{ steps.version.outputs.VERSION }}
          
          ### Installation Options:
          
          1. **AppImage (Recommended)** - Download the `Speech-to-Text-Agent-*.AppImage` file below
          2. **Source Installation** - Clone the repository and run `./setup.sh`
          
          ### Features:
          - Real-time speech recognition using VOSK
          - GTK3 interface with visual feedback
          - Smart text input with focus management
          - Desktop integration
          - Works offline after setup
          
          ### Requirements:
          - Ubuntu 18.04+ with GNOME
          - Python 3.6+
          - Microphone
          - xdotool (auto-installed)
          
          ### Quick Start (AppImage):
          ```bash
          chmod +x Speech-to-Text-Agent-*.AppImage
          ./Speech-to-Text-Agent-*.AppImage
          ```
          
          See the [README.md](https://github.com/eSlider/speech-to-text-copy-paste/blob/main/README.md) for detailed instructions.
        files: |
          *.AppImage
          *.md
          *.desktop
          *.sh
        draft: false
        prerelease: false
        generate_release_notes: true
        
    - name: Create Badges
      uses: actions/upload-artifact@v3
      with:
        name: badges
        path: |
          .github/badges/
        retention-days: 90

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install semantic-release
      run: |
        npm install -g semantic-release
        npm install -g @semantic-release/git
        npm install -g @semantic-release/github
        npm install -g @semantic-release/changelog
        npm install -g @semantic-release/commit-analyzer
        npm install -g @semantic-release/release-notes-generator
        
    - name: Create semantic-release config
      run: |
        cat > .releaserc.json << 'EOF'
        {
          "branches": ["main", "master"],
          "plugins": [
            "@semantic-release/commit-analyzer",
            "@semantic-release/release-notes-generator",
            "@semantic-release/changelog",
            "@semantic-release/github",
            [
              "@semantic-release/git",
              {
                "assets": ["CHANGELOG.md"],
                "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
              }
            ]
          ]
        }
        EOF
        
    - name: Run semantic-release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        semantic-release
        
  update-badges:
    name: Update Project Badges
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always() && (needs.test.result == 'success' || needs.build.result == 'success')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create badges
      run: |
        mkdir -p .github/badges
        
        # Create build status badge
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… Tests Passed" > .github/badges/build-status.txt
        else
          echo "âŒ Tests Failed" > .github/badges/build-status.txt
        fi
        
        # Create release badge
        VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
        echo "ðŸ“¦ $VERSION" > .github/badges/latest-version.txt
        
        # Create compatibility badge
        echo "ðŸ§ Ubuntu 18.04+" > .github/badges/compatibility.txt
        
    - name: Update README with badges
      run: |
        # Add badges section to README
        sed -i '3i\\n## Project Status\n\n![Tests](https://img.shields.io/github/workflow/status/eSlider/speech-to-text-copy-paste/Build%20and%20Release)\n![Release](https://img.shields.io/github/v/release/eSlider/speech-to-text-copy-paste)\n![License](https://img.shields.io/github/license/eSlider/speech-to-text-copy-paste)\n![Platform](https://img.shields.io/badge/platform-Uuntu%2018.04%2B-blue)\n' README.md
        
    - name: Commit badges
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md .github/badges/
        git diff --staged --quiet || git commit -m "chore: update project badges [skip ci]"
        git push