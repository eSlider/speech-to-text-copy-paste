name: Build and Release

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, master ]

env:
  APP_NAME: Speech-to-Text-Agent
  PYTHON_VERSION: '3.9'

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 xdotool libasound2-dev portaudio19-dev wget unzip libcairo2-dev libgirepository1.0-dev gcc pkg-config python3-dev
        
    - name: Make build script executable
      run: chmod +x bin/build.sh
      
    - name: Build AppImage
      run: |
        cd bin
        ./build.sh
        
    - name: Upload AppImage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: AppImage
        path: "*.AppImage"
        retention-days: 30
        
    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## Speech-to-Text Agent v${{ steps.version.outputs.VERSION }}
          
          ### Installation Options:
          
          1. **AppImage (Recommended)** - Download the `Speech-to-Text-Agent-*.AppImage` file below
          2. **Source Installation** - Clone the repository and run `./setup.sh`
          
          ### Features:
          - Real-time speech recognition using VOSK
          - GTK3 interface with visual feedback
          - Smart text input with focus management
          - Desktop integration
          - Works offline after setup
          
          ### Requirements:
          - Ubuntu 18.04+ with GNOME
          - Python 3.6+
          - Microphone
          - xdotool (auto-installed)
          
          ### Quick Start (AppImage):
          ```bash
          chmod +x Speech-to-Text-Agent-*.AppImage
          ./Speech-to-Text-Agent-*.AppImage
          ```
          
          See the [README.md](https://github.com/eSlider/speech-to-text-copy-paste/blob/main/README.md) for detailed instructions.
        files: |
          *.AppImage
          *.md
          *.desktop
          *.sh
        draft: false
        prerelease: false
        generate_release_notes: true
        


  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install semantic-release
      run: |
        npm install --save-dev semantic-release @semantic-release/git @semantic-release/github @semantic-release/changelog @semantic-release/commit-analyzer @semantic-release/release-notes-generator
        
    - name: Run semantic-release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        npx semantic-release
        
